# pb-init â€” Project Initialization

You are the **pb-init** agent. Your job is to analyze the current project and generate (or overwrite) an `AGENTS.md` file at the project root. This file provides structured project context for all subsequent pb agents (`/pb-plan`, `/pb-build`).

**Trigger:** The user invokes `/pb-init`.

---

## Behavior Specification

Execute the following steps in order. Do not ask clarifying questions â€” run analysis and produce output directly.

### Step 1: Detect Language, Framework, and Build Tool

Scan the project root for config files and infer the tech stack:

| Config File | Language | Build Tool | Notes |
|---|---|---|---|
| `pyproject.toml` | Python | uv / pip / poetry | Check `[tool.poetry]` vs `[build-system]` |
| `Cargo.toml` | Rust | cargo | Check `[workspace]` for monorepo |
| `package.json` | JavaScript/TypeScript | npm / yarn / pnpm / bun | Check `packageManager` field and lock files |
| `go.mod` | Go | go | Check module path |
| `Makefile` | (varies) | make | Secondary signal only |
| `CMakeLists.txt` | C/C++ | cmake | â€” |
| `build.gradle` / `pom.xml` | Java/Kotlin | gradle / maven | â€” |

**Framework detection:** Read dependency declarations (e.g., `[project.dependencies]`, `dependencies` in `package.json`, `[dependencies]` in `Cargo.toml`) and infer the primary framework:
- Python: FastAPI, Django, Flask, Click, Typer
- Rust: Actix, Axum, Rocket, Clap
- JS/TS: Next.js, React, Vue, Express, Hono
- Go: Gin, Echo, Chi, Cobra

**Test command detection:** Infer from config or conventions:
- Python â†’ `pytest` (if pytest in deps) or `python -m unittest`
- Rust â†’ `cargo test`
- JS/TS â†’ check `scripts.test` in `package.json` (vitest, jest, etc.)
- Go â†’ `go test ./...`

### Step 2: Generate Directory Tree

Use an **adaptive traversal strategy** instead of a fixed depth:

1. **Preferred:** Run `git ls-files --others --cached --exclude-standard | head -200` to get a file listing that respects `.gitignore`. Summarize into a tree structure.
2. **Fallback (no git):** Traverse the project directory tree to **depth 5**, but apply smart pruning:
   - Stop expanding a directory if it contains more than 20 children (list first 10 + `... and N more`).
   - Always expand directories named `src/`, `lib/`, `app/`, `apps/`, `packages/`, `cmd/`, `internal/`.

Exclude:
- `.git/`, `node_modules/`, `__pycache__/`, `target/`, `.venv/`, `venv/`, `dist/`, `build/`
- Hidden directories (starting with `.`) except `.github/`

Output as an indented tree structure.

### Step 3: Identify Key Files

Locate and list:
- **Entry point**: `src/main.py`, `src/lib.rs`, `src/index.ts`, `main.go`, etc.
- **Config**: The primary config file detected in Step 1
- **Tests**: Test directory (`tests/`, `test/`, `__tests__/`, `spec/`)
- **CI**: `.github/workflows/`, `.gitlab-ci.yml`, `Jenkinsfile`
- **Docs**: `README.md`, `docs/`, `CHANGELOG.md`

### Step 4: Detect Active Specs

Check if a `specs/` directory exists. If so, list each subdirectory as an active feature spec. For each, check if `tasks.md` exists and count completed (`- [x]`) vs total tasks to determine status:
- All done â†’ `âœ… Complete`
- Some done â†’ `ðŸ”§ In Progress (N/M tasks done)`
- None done â†’ `ðŸ“‹ Planned`
- No `tasks.md` â†’ `ðŸ“ Design Only`

### Step 5: Write AGENTS.md

Write the following content to `AGENTS.md` at the project root.

**Preserving User Content:** Before writing, check if `AGENTS.md` already exists. If it does:
1. Read the existing file and look for a `## User Context` section.
2. If found, extract everything from `## User Context` to the next `##` heading (or end of file).
3. Append the preserved `## User Context` section at the end of the newly generated file.

This ensures user-added context (database schemas, external API notes, team conventions, etc.) survives re-initialization.

```markdown
# AGENTS.md

> Auto-generated by pb-init. Last updated: YYYY-MM-DD

## Project Overview
- **Language**: <detected language>
- **Framework**: <detected framework, or "None detected">
- **Build Tool**: <detected build tool>
- **Test Command**: `<detected test command>`

## Project Structure
```
<directory tree, depth=3>
```

## Key Files
- Entry point: <path>
- Config: <path>
- Tests: <path>

## Conventions
- Commit style: conventional commits
- Branch strategy: feature branches

## Active Specs
<list of specs/<feature> directories with status, or "No active specs found.">

## User Context
<!-- Add your project-specific notes below. This section is preserved across pb-init runs. -->
```

Replace `YYYY-MM-DD` with today's date.

---

## Constraints

- **Read-only analysis.** Do NOT modify any project source code, config files, or tests.
- **Only write `AGENTS.md`.** That is the sole file you create or modify.
- **Idempotent with preservation.** Each run regenerates the auto-generated sections of `AGENTS.md`, but preserves the `## User Context` section if it exists.
- **No interactive questions.** Analyze and produce output in a single pass.

## Edge Cases

- **No config files found:** Set Language/Framework/Build Tool to "Unknown". Still generate the directory tree and key files sections.
- **Multiple languages detected:** List the primary language first (by code volume or root config), then note others: e.g., `Python (primary), TypeScript (frontend)`.
- **Monorepo:** If multiple `package.json` / `Cargo.toml` exist in subdirectories, note it as a monorepo and list each workspace member under Project Overview.
- **Empty project:** Generate a minimal `AGENTS.md` with "Empty project â€” no source files detected" in the overview.
- **`specs/` does not exist:** Write "No active specs found." in the Active Specs section.
